<script>
  const groupContainer = document.getElementById("id-boxes");
  const currentListEl = document.getElementById("current-list");
  const uniqueUsers = new Map();

  async function loadGroupsFromFirebase() {
    groupContainer.innerHTML = ""; // clear before reload
    currentListEl.innerHTML = "";
    uniqueUsers.clear();

    try {
      const groupsSnapshot = await db.collection("Groups").get();

      for (const groupDoc of groupsSnapshot.docs) {
        const groupName = groupDoc.id;
        const usersRef = db.collection("Groups").doc(groupName).collection("Users");
        const usersSnapshot = await usersRef.get();

        const userList = [];
        usersSnapshot.forEach((userDoc) => {
          const username = userDoc.id;
          const data = userDoc.data();
          const role = data.role || "student";
          userList.push(`<div>${username} <span class="role-student">[${role}]</span></div>`);
          if (!uniqueUsers.has(username)) uniqueUsers.set(username, role);
        });

        const box = document.createElement("div");
        box.className = "id-box";
        box.innerHTML = `
          <strong>${groupName}</strong>
          ${userList.join("")}
          <button class="remove-btn" onclick="deleteGroup('${groupName}')">Delete Group</button>
        `;
        groupContainer.appendChild(box);
      }

      for (const [username, role] of uniqueUsers.entries()) {
        const li = document.createElement("li");
        li.innerHTML = `
          ${username} <span class="role-student">[${role}]</span>
          <button class="remove-btn" onclick="removeUserFromAllGroups('${username}')">Remove</button>
        `;
        currentListEl.appendChild(li);
      }
    } catch (error) {
      console.error("Error loading groups from Firebase:", error);
    }
  }

  async function deleteGroup(groupName) {
    const confirmDelete = confirm(`Are you sure you want to delete group: ${groupName}?`);
    if (!confirmDelete) return;

    try {
      const usersSnapshot = await db.collection("Groups").doc(groupName).collection("Users").get();
      const batch = db.batch();

      usersSnapshot.forEach(doc => {
        batch.delete(doc.ref);
      });

      await batch.commit();
      await db.collection("Groups").doc(groupName).delete();

      alert(`Group "${groupName}" deleted`);
      loadGroupsFromFirebase();
    } catch (err) {
      console.error("Failed to delete group:", err);
      alert("Error deleting group.");
    }
  }

  async function removeUserFromAllGroups(username) {
    try {
      const groupsSnapshot = await db.collection("Groups").get();
      const batch = db.batch();

      for (const groupDoc of groupsSnapshot.docs) {
        const userRef = db.collection("Groups").doc(groupDoc.id).collection("Users").doc(username);
        const userDoc = await userRef.get();
        if (userDoc.exists) batch.delete(userRef);
      }

      await batch.commit();
      alert(`Removed "${username}" from all groups.`);
      loadGroupsFromFirebase();
    } catch (err) {
      console.error("Failed to remove user:", err);
      alert("Error removing user.");
    }
  }

  // Adding users
  document.addEventListener("click", async (e) => {
    if (e.target.classList.contains("add-btn")) {
      const box = e.target.closest(".id-box");
      const inputs = box.querySelectorAll("input");
      const groupName = inputs[0].value.trim();
      const username = inputs[1].value.trim();

      if (!groupName || !username) {
        alert("Enter both team name and username.");
        return;
      }

      try {
        const userRef = db.collection("Groups").doc(groupName).collection("Users").doc(username);
        await userRef.set({ role: "student" });
        alert(`Added ${username} to ${groupName}`);
        loadGroupsFromFirebase();
      } catch (err) {
        console.error("Failed to add user:", err);
        alert("Error adding user.");
      }
    }
  });

  window.onload = () => {
    loadGroupsFromFirebase();
  };
</script>
