<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Classroom</title>
  <link rel="stylesheet" href="ManageClass.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body>
  <div class="container">
    <div class="dashboard-button-wrapper">
      <button type="button" onclick="location.href='TeacherDashboard.html'">
        Back to Dashboard
      </button>
    </div>

    <h1>Manage Classroom</h1>

    <div class="main-content">
      <!-- Overview -->
      <div class="column">
        <div class="section-header">Overview</div>
        <div class="section">
          <h2>For approval</h2>
          <ul class="approval-list" id="approval-list"></ul>

          <h2>Current List</h2>
          <ul class="current-list" id="current-list"></ul>
        </div>
      </div>

      <!-- Teams -->
      <div class="column">
        <div class="section-header">Teams</div>
        <div class="section">
          <div class="card-container" id="teamContainer">
            <div class="id-box plus" onclick="showForm(this, event)">+</div>
          </div>
        </div>
      </div>

      <!-- Flagged -->
      <div class="column">
        <div class="section-header">Flagged</div>
        <div class="section">
          <p>(Placeholder for flagged users)</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadGroupsFromFirebase() {
  const teamContainer = document.getElementById("teamContainer");
  const currentList = document.getElementById("current-list");
  const approvalList = document.getElementById("approval-list");

  // Clears old content
  currentList.innerHTML = "";
  approvalList.innerHTML = "";

  // Loads and render users by role
  const usersSnap = await db.collection("Users").get();
  usersSnap.forEach(doc => {
    const username = doc.id;
    const role = doc.data().role;

    const li = document.createElement("li");
    li.textContent = username;

    if (role == "Unconfirmed") {
      li.innerHTML += ` <button class="approve-btn" onclick="approveUser('${username}')">approve</button>`;
      approvalList.appendChild(li);
    } else {
      li.innerHTML += ` <button class="remove-btn" onclick="removeUser('${username}')">remove</button>`;
      currentList.appendChild(li);
    }
  });

  // Loads groups into the Teams section
  const snapshot = await db.collection("Groups").get();
  snapshot.forEach(async (groupDoc) => {
    const groupName = groupDoc.id;
    const usersRef = db.collection("Groups").doc(groupName).collection("Users");
    const usersSnap = await usersRef.get();

    let membersHTML = "<ul>";
    usersSnap.forEach(userDoc => {
      const username = userDoc.id;
      membersHTML += `<li>${username}</li>`;
    });
    membersHTML += "</ul>";

    const box = document.createElement("div");
    box.className = "id-box";
    box.innerHTML = `
      <strong>${groupName}</strong>
      ${membersHTML}
      <button class="remove-btn" onclick="removeTeam(this)">Remove</button>
    `;
    teamContainer.insertBefore(box, teamContainer.lastElementChild);
  });
}


    function showForm(card, event) {
      if (event) event.stopPropagation();
      card.classList.remove('plus');
      card.innerHTML = `
        <input type="text" placeholder="Team name" class="team-name" autofocus /><br/>
        <input type="text" placeholder="Members (comma-separated)" class="team-members" /><br/>
        <button class="add-btn" onclick="addTeam(this)">Add</button>
      `;
    }

    async function addTeam(button) {
      const box = button.parentElement;
      const teamName = box.querySelector('.team-name').value.trim() || 'Untitled Team';
      const membersInput = box.querySelector('.team-members').value.trim();
      const members = membersInput
        ? membersInput.split(',').map(name => name.trim()).filter(Boolean)
        : [];

      // Save to Firebase
      try {
        const groupRef = db.collection("Groups").doc(teamName);
        const usersRef = groupRef.collection("Users");
        for (const username of members) {
          await usersRef.doc(username).set({ role: "student" });
        }
      } catch (error) {
        console.error("Error adding team to Firestore:", error);
      }

      // Update UI
      let membersHTML = '<ul>';
      members.forEach(member => {
        membersHTML += `<li>${member}</li>`;
      });
      membersHTML += '</ul>';

      box.innerHTML = `
        <strong>${teamName}</strong>
        ${membersHTML}
        <button class="remove-btn" onclick="removeTeam(this)">Remove</button>
      `;

      const container = document.getElementById("teamContainer");
      const newCard = document.createElement("div");
      newCard.className = "id-box plus";
      newCard.textContent = "+";
      newCard.onclick = function (event) {
        showForm(this, event);
      };
      container.appendChild(newCard);
    }

    async function removeTeam(button) {
  const card = button.parentElement;
  const groupName = card.querySelector("strong")?.innerText;

  if (!groupName) {
    alert("Error: Group name not found.");
    return;
  }

  const confirmed = confirm(`Are you sure you want to delete the group "${groupName}"?`);
  if (!confirmed) return;

  try {
    const groupRef = db.collection("Groups").doc(groupName);

    // Delete the group document itself
    await groupRef.delete();

    // Remove from UI
    card.remove();
    alert(`Group "${groupName}" has been deleted.`);
  } catch (error) {
    console.error("Error deleting group:", error);
    alert("Failed to delete group. Please try again.");
  }
}
async function approveUser(username) {
  try {
    await db.collection("Users").doc(username).update({ role: "student" });
    alert(`${username} approved.`);
    loadGroupsFromFirebase(); // Refresh the lists
  } catch (error) {
    console.error("Error approving user:", error);
    alert("Could not approve user.");
  }
}

async function removeUser(username) {
  const confirmed = confirm(`Remove user ${username}?`);
  if (!confirmed) return;

  try {
    await db.collection("Users").doc(username).delete();
    alert(`${username} removed.`);
    loadGroupsFromFirebase(); // Refresh the lists
  } catch (error) {
    console.error("Error removing user:", error);
    alert("Could not remove user.");
  }
}



    window.onload = () => {
      loadGroupsFromFirebase();
    };
  </script>
</body>
</html>
