<<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Classroom</title>
  <link rel="stylesheet" href="ManageClass.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lato&family=Roboto+Mono&display=swap" rel="stylesheet" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script>
    
    
    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

  
<body>
  <div class="container">
    <div class="header-bar">
      <h1>Manage Classroom</h1>
      <div class="dashboard-button-wrapper">
        <button type="button" onclick="location.href='TeacherDashboard.html'">Back to Dashboard</button>
      </div>
    </div>

    <div class="main-content">
      <!-- Overview -->
      <div class="column">
        <div class="section-header">Overview</div>
        <div class="section">
          <h2>For approval</h2>
          <ul class="approval-list" id="approval-list"></ul>
          <h2>Current List</h2>
          <ul class="current-list" id="current-list"></ul>
        </div>
      </div>

      <!-- Teams -->
      <div class="column">
        <div class="section-header">Teams</div>
        <div class="section">
          <div class="card-container" id="teamContainer">
            <div class="id-box plus" onclick="showForm(this, event)">+</div>
          </div>
        </div>
      </div>

      <!-- Flagged -->
      <div class="column">
        <div class="section-header">Flagged</div>
        <div class="section flagged">
          <p>(Placeholder for flagged users)</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function loadGroupsFromFirebase() {
  const teamContainer = document.getElementById("teamContainer");
  const currentList = document.getElementById("current-list");
  const approvalList = document.getElementById("approval-list");

  // Clears old content
  currentList.innerHTML = "";
  approvalList.innerHTML = "";

  // Loads and render users by role
  const usersSnap = await db.collection("users").get();
  usersSnap.forEach(doc => {
    const username = doc.id;
    const role = doc.data().role;

    const li = document.createElement("li");
    li.textContent = username;

    if (role == "Unconfirmed") {
      li.innerHTML += `
        <div style="display: flex; gap: 8px;">
          <button class="approve-btn" onclick="approveUser('${username}')">approve</button>
          <button class="reject-btn" onclick="rejectUser('${username}')">reject</button>
        </div>`;
      approvalList.appendChild(li);
    } else {
      li.innerHTML += ` <button class="remove-btn" onclick="removeUser('${username}')">remove</button>`;
      currentList.appendChild(li);
    }
  });

  // Loads groups into the Teams section
  const snapshot = await db.collection("Groups").get();
  snapshot.forEach(async (groupDoc) => {
    const groupName = groupDoc.id;
    const usersRef = db.collection("Groups").doc(groupName).collection("Users");
    const usersSnap = await usersRef.get();

    let membersHTML = "<ul>";
    usersSnap.forEach(userDoc => {
      const username = userDoc.id;
      membersHTML += `<li>${username}</li>`;
    });
    membersHTML += "</ul>";

    const box = document.createElement("div");
    box.className = "id-box";
    box.innerHTML = `
      <strong>${groupName}</strong>
      ${membersHTML}
      <button class="remove-btn" onclick="removeTeam(this)">Remove</button>
    `;
    teamContainer.insertBefore(box, teamContainer.lastElementChild);
  });
}


    function showForm(card, event) {
  if (event) event.stopPropagation();

  // Prevent showing multiple forms
  if (!card.classList.contains('plus')) return;

  card.classList.remove('plus');
  card.innerHTML = `
    <input type="text" placeholder="Team name" class="team-name" autofocus /><br/>
    <input type="text" placeholder="Members (comma-separated)" class="team-members" /><br/>
    <button class="add-btn" onclick="addTeam(this)">Add</button>
  `;

  // Focus manually in case autofocus doesn't trigger
  setTimeout(() => {
    card.querySelector('.team-name').focus();
  }, 100);
}


   async function addTeam(button) {
  const box = button.parentElement;
  const teamName = box.querySelector('.team-name').value.trim() || 'Untitled Team';
  const membersInput = box.querySelector('.team-members').value.trim();
  const members = membersInput
    ? membersInput.split(',').map(name => name.trim()).filter(Boolean)
    : [];

  try {
    const groupRef = db.collection("Groups").doc(teamName);
    const usersRef = groupRef.collection("Users");

    for (const username of members) {
      // Add user to the group subcollection
      await usersRef.doc(username).set({ role: "Student" });

      // Update the user document with their group
      await db.collection("users").doc(username).update({
        group: teamName,
        role: "Student" // Optional: assign role here too
      });
    }
  } catch (error) {
    console.error("Error adding team to Firestore:", error);
    alert("Error adding team. Please check if users exist.");
    return;
  }

  // Rebuild the card content
  let membersHTML = '<ul>';
  members.forEach(member => {
    membersHTML += `<li>${member}</li>`;
  });
  membersHTML += '</ul>';

  box.innerHTML = `
    <strong>${teamName}</strong>
    ${membersHTML}
    <button class="remove-btn" onclick="removeTeam(this)">Remove</button>
  `;

  // Add a new "+" box if not already present
  const container = document.getElementById("teamContainer");
  const hasPlusBox = container.querySelector(".id-box.plus");
  if (!hasPlusBox) {
    const newCard = document.createElement("div");
    newCard.className = "id-box plus";
    newCard.textContent = "+";
    newCard.onclick = function (event) {
      showForm(this, event);
    };
    container.appendChild(newCard);
  }
}

async function approveUser(username) {
  try {
    await db.collection("users").doc(username).update({ role: "Student" });
    alert(`${username} approved.`);
    loadGroupsFromFirebase(); // Refresh the lists
  } catch (error) {
    console.error("Error approving user:", error);
    alert("Could not approve user.");
  }
}
    
async function rejectUser(username) {
  const confirmed = confirm(`Reject and delete user "${username}" from the system?`);
  if (!confirmed) return;

  try {
    await db.collection("users").doc(username).delete();
    alert(`${username} rejected and removed.`);
    loadGroupsFromFirebase(); // Refresh the UI
  } catch (error) {
    console.error("Error rejecting user:", error);
    alert("Failed to reject user.");
  }
}

async function removeTeam(button) {
  const card = button.parentElement;
  const groupName = card.querySelector("strong")?.innerText;

  if (!groupName) {
    alert("Error: Group name not found.");
    return;
  }

  const confirmed = confirm(`Are you sure you want to delete the group "${groupName}"?`);
  if (!confirmed) return;

  try {
    const groupRef = db.collection("Groups").doc(groupName);

    // Delete all users in the group subcollection
    const usersSnap = await groupRef.collection("users").get();
    const deletePromises = usersSnap.docs.map(doc => doc.ref.delete());
    await Promise.all(deletePromises);

    // Delete the group doc
    await groupRef.delete();

    card.remove();
    alert(`Group "${groupName}" has been deleted.`);
  } catch (error) {
    console.error("Error deleting group:", error);
    alert("Failed to delete group. Please try again.");
  }
}

    window.onload = () => {
      loadGroupsFromFirebase();
    };
  </script>
</body>
</html>
