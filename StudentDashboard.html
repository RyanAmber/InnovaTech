<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="StudentDashboard.css">
</head>
<body>
  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>

    <div class="right">
      

      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>

        <form id="addForm" class="add-form" style="display: none;">
          <input type="text" id="newType" placeholder="Component type" required />
          <input type="text" id="newImage" placeholder="Image URL (optional)" />
          <label><input type="checkbox" id="newWorking" checked /> Working</label>
          <input type="text" id="newGroup" placeholder="Group (Set to 0 if in storage)" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-left">
        <h2 id="modalTitle" class="component-name">Component_Name</h2>
        <h3>Component Overview</h3>
        <div class="overview-box">
          <p>Number logged in: <span id="totalCount">X</span></p>
          <p>Number Available: <span id="AvailableCount">X</span></p>
        </div>
        <h3>Actions</h3>
        <div class="actions">
          <button class="action-btn" onclick="checkOutComponent()">Check out Component</button>
          <button class="action-btn">Mark as damaged or broken</button>
          <button class="action-btn" onclick="returnComponent()">Return Component</button>
        </div>
      </div>
      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      addDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const username = localStorage.getItem("username") || "Student";
    if (username === "Student") {
      window.location.href = 'index.html';
    }
    document.getElementById("usernameHeader").textContent = `Welcome, ${username}`;
    document.title = `${username}'s Dashboard`;

    const workingMap = new Map();
    const availableMap = new Map();
    const countMap = new Map();
    const imageMap = new Map();

    function openModal(name, imageUrl) {
      const total = countMap.get(name) || 0;
      const working = workingMap.get(name) || 0;
      const available = availableMap.get(name) || 0;

      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modalTitle').textContent = name;
      document.getElementById('modalImage').src = imageUrl;
      document.getElementById('totalCount').textContent = total;
      document.getElementById('AvailableCount').textContent = available;

      const greenPercent = total > 0 ? Math.round((working / total) * 100) : 0;
      const redPercent = 100 - greenPercent;
      const statusBar = document.querySelector('.status-bar');

      if (total === 0) {
        statusBar.innerHTML = `<div class="status yellow" style="width: 100%">100%</div>`;
      } else {
        statusBar.innerHTML = `
          <div class="status green" style="width: ${greenPercent}%">${greenPercent}%</div>
          <div class="status red" style="width: ${redPercent}%">${redPercent > 0 ? redPercent + '%' : ''}</div>
        `;
      }
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function addNotification(message) {
      const bar = document.getElementById('notification-bar');
      const note = document.createElement('div');
      note.className = 'notif';
      note.textContent = message;
      bar.appendChild(note);
      bar.style.display = 'block';
    }
    async function loadComponents() {
  const grid = document.getElementById("component-grid");
  const loading = document.getElementById("loading");

  try {
    const inventoryRef = collection(db, "inventory");
    const snapshot = await getDocs(inventoryRef);

    if (snapshot.empty) {
      loading.textContent = "No components found.";
      return;
    }

    loading.style.display = "none";
    grid.style.display = "grid";

    snapshot.forEach(docSnap => {
      const name = docSnap.id;

      const partsRef = collection(db, "inventory", name, "parts");
      getDocs(partsRef).then(partsSnapshot => {
        let total = 0;
        let available = 0;
        let working = 0;

        partsSnapshot.forEach(partDoc => {
          total++;
          const data = partDoc.data();
          if (data.working) working++;
          if (data.working && data.team === "0") available++;
        });

        countMap.set(name, total);
        workingMap.set(name, working);
        availableMap.set(name, available);

        const tile = document.createElement("div");
        tile.className = "component-tile";
        tile.innerHTML = `
          <h3>${name}</h3>
          <p>Total: ${total}</p>
          <p>Available: ${available}</p>
        `;

        tile.addEventListener("click", () => {
          const imageUrl = imageMap.get(name) || "https://via.placeholder.com/150";
          openModal(name, imageUrl);
        });

        grid.appendChild(tile);
      });
    });

  } catch (err) {
    console.error("Error loading components:", err);
    loading.textContent = "Error loading components.";
  }
}

    async function checkOutComponent() {
  const name = document.getElementById('modalTitle').textContent;

  try {
    const partsRef = collection(db, "inventory", name, "parts");
    const partsSnapshot = await getDocs(partsRef);

    const availablePart = partsSnapshot.docs.find(doc => {
      const data = doc.data();
      return data.working === true && data.team === "0";
    });

    if (!availablePart) {
      alert("No available components to check out.");
      return;
    }

    const userGroup = localStorage.getItem("group") || "Group 0";
    const partId = availablePart.id;

    // Step 1: Update inventory to assign to this group
    const partDocRef = doc(db, "inventory", name, "parts", partId);
    await setDoc(partDocRef, { team: userGroup }, { merge: true });

    // Step 2: Add to group's Items list
    const groupItemRef = doc(db, "Groups", userGroup, "Items", partId);
    await setDoc(groupItemRef, {
      type: name,
      checkedOutAt: new Date().toISOString(),
      working: true
    });

    alert(`Checked out one ${name} to ${userGroup}.`);
    closeModal();
    location.reload(); // optional UI update
  } catch (err) {
    console.error("Checkout failed:", err);
    closeModal();
    alert("Error checking out component.");
  }
}

window.returnComponent = async function returnComponent() {
  const name = document.getElementById('modalTitle').textContent;
  const userGroup = localStorage.getItem("group") || "Group 0";

  try {
    // Find the part currently checked out by this group
    const partsRef = collection(db, "inventory", name, "parts");
    const partsSnapshot = await getDocs(partsRef);

    const checkedOutPart = partsSnapshot.docs.find(doc => {
      const data = doc.data();
      return data.working === true && data.team === userGroup;
    });

    if (!checkedOutPart) {
      alert("You have no checked out components of this type.");
      return;
    }

    // 1. Set team back to "0" (in storage)
    const partDocRef = doc(db, "inventory", name, "parts", checkedOutPart.id);
    await setDoc(partDocRef, { team: "0" }, { merge: true });

    // 2. Remove from group's Items list
    const groupResRef = doc(db, "Groups", userGroup, "Items", checkedOutPart.id);
    await deleteDoc(groupResRef);

    alert(`Returned one ${name} from ${userGroup}.`);
    closeModal();
    location.reload();
  } catch (err) {
    console.error("Return failed:", err);
    closeModal();
    alert("Error returning component.");
  }
};

    window.checkOutComponent = checkOutComponent;
    loadComponents();

    window.onclick = function(e) {
      const modal = document.getElementById('modal');
      if (e.target === modal) closeModal();
    };
  </script>
</body>
</html>
