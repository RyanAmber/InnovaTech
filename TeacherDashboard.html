<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="TeacherDashboard.css">
</head>
<body>
  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>

    <div class="right">
      <div class="admin-nav">
        <div class="bubble-heading">Navigation</div>
        <a href="ManageClass.html"><button type="button">Manage Classroom</button></a>
      </div>

      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>

        <form id="addForm" class="add-form" style="display: none;">
          <input type="text" id="newType" placeholder="Component type" required />
          <input type="text" id="newImage" placeholder="Image URL (optional)" />
          <label><input type="checkbox" id="newWorking" checked /> Working</label>
          <input type="text" id="newGroup" placeholder="Group (Set to 0 if in storage)" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-left">
        <h2 id="modalTitle" class="component-name">Component_Name</h2>
        <h3>Component Overview</h3>
        <div class="overview-box">
          <p>Number logged in: <span id="totalCount">X</span></p>
          <p>Number Available: <span id="AvailableCount">X</span></p>
          <p>Number Working: <span id="WorkingCount">X</span></p>
        </div>
        <h3>Actions</h3>
        <div class="actions">
          <button id="toggleAddBtn" class="add-btn"> Add Component</button>
          <button id="removeComponentBtn" class="action-btn">Remove Component</button>
        </div>
        <h3>Individual Parts</h3>
        <div id="partsList" class="parts-list"></div>
      </div>
      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      addDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const username = localStorage.getItem("username") || "Student";
    if (username === "Student") {
      window.location.href = 'index.html';
    }
    document.getElementById("usernameHeader").textContent = `Welcome, ${username}`;
    document.title = `${username}'s Dashboard`;

    const workingMap = new Map();
    const availableMap = new Map();
    const countMap = new Map();
    const imageMap = new Map();

    function toggleAddForm() {
      const form = document.getElementById("addForm");
      form.style.display = form.style.display === "none" ? "block" : "none";
    }

    document.getElementById("toggleAddBtn").addEventListener("click", toggleAddForm);

    async function addComponent() {
      const type = document.getElementById("newType").value.trim();
      const image = document.getElementById("newImage").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
      const working = document.getElementById("newWorking").checked;
      const team = document.getElementById("newGroup").value.trim();

      if (!type) {
        alert("Component type is required.");
        return;
      }
      if (!team) {
        alert("Component team is required.");
        return;
      }
      try {
        // Sets the image for the type in inventory/[type] doc so that all items of that type will use one image
        await setDoc(doc(db, "inventory", type), { image }, { merge: true });

        // Adds a new part in inventory/[type]/parts/
        const partsRef = collection(db, "inventory", type, "parts");
        await addDoc(partsRef, {
          working,
          team
        });

        alert("Component added successfully!");
        document.getElementById("addForm").reset();
        document.getElementById("addForm").style.display = "none";

        // Clears and reloads
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear();
        workingMap.clear();
        availableMap.clear();
        loadComponents();
      } catch (error) {
        console.error("Error adding component:", error);
        alert("Failed to add component.");
      }
    }
    document.getElementById("addForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addComponent();
    });
let currentComponentType = null; // Global variable
import { getDocs, deleteDoc, doc, collection } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

async function openModal(name, imageUrl) {
  currentComponentType = name;

  const total = countMap.get(name) || 0;
  const working = workingMap.get(name) || 0;
  const available = availableMap.get(name) || 0;

  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modalTitle').textContent = name;
  document.getElementById('modalImage').src = imageUrl;
  document.getElementById('totalCount').textContent = total;
  document.getElementById('AvailableCount').textContent = available;
  document.getElementById('WorkingCount').textContent = working;
        const greenPercent = total > 0 ? Math.round((working / total) * 100) : 0;
      const redPercent = 100 - greenPercent;
      const statusBar = document.querySelector('.status-bar');

      if (total === 0) {
  statusBar.innerHTML = `<div class="status yellow" style="width: 100%">100%</div>`;
} else {
  statusBar.innerHTML = `
    <div class="status green" style="width: ${greenPercent}%">${greenPercent}%</div>
    <div class="status red" style="width: ${redPercent}%">${redPercent > 0 ? redPercent + '%' : ''}</div>
  `;
}


  // Load and show individual parts
  const partsContainer = document.getElementById('partsList');
  partsContainer.innerHTML = "Loading parts...";

  const partsRef = collection(db, "inventory", name, "parts");
  const partsSnapshot = await getDocs(partsRef);

  if (partsSnapshot.empty) {
    partsContainer.innerHTML = "<p>No parts found.</p>";
    return;
  }

  partsContainer.innerHTML = "";
  partsSnapshot.forEach(partDoc => {
    const data = partDoc.data();
    const div = document.createElement("div");
    div.className = "part-entry";
    div.innerHTML = `
      <p>Team: ${data.team} | Working: ${data.working ? '✅' : '❌'}</p>
      <button data-id="${partDoc.id}" class="remove-part-btn">Remove</button>
    `;
    partsContainer.appendChild(div);
  });

  // Attach delete listeners
  partsContainer.querySelectorAll(".remove-part-btn").forEach(button => {
    button.addEventListener("click", async () => {
      const partId = button.getAttribute("data-id");
      const confirmDelete = confirm("Delete this specific part?");
      if (!confirmDelete) return;

      try {
        await deleteDoc(doc(db, "inventory", name, "parts", partId));
        alert("Part removed.");
        closeModal();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear();
        workingMap.clear();
        availableMap.clear();
        loadComponents();
      } catch (err) {
        console.error("Error deleting part:", err);
        alert("Failed to delete part.");
      }
    });
  });
}


    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function addNotification(message) {
      const bar = document.getElementById('notification-bar');
      const note = document.createElement('div');
      note.className = 'notif';
      note.textContent = message;
      bar.appendChild(note);
      bar.style.display = 'block';
    }

    async function loadComponents() {
      const grid = document.getElementById("component-grid");
      const loading = document.getElementById("loading");

      try {
        const inventorySnapshot = await getDocs(collection(db, "inventory"));

        for (const typeDoc of inventorySnapshot.docs) {
          const type = typeDoc.id;
          const image = typeDoc.data().image || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
          imageMap.set(type, image);

          const partsRef = collection(db, "inventory", type, "parts");
          const partsSnapshot = await getDocs(partsRef);

          partsSnapshot.forEach(partDoc => {
            const { working, team } = partDoc.data();
            countMap.set(type, (countMap.get(type) || 0) + 1);
            if (working) {
              workingMap.set(type, (workingMap.get(type) || 0) + 1);
              if (team == "0") {
                availableMap.set(type, (availableMap.get(type) || 0) + 1);
              }
            }
          });
        }

        for (const [type, image] of imageMap) {
          const card = document.createElement("div");
          card.className = "card";
          card.onclick = () => openModal(type, image);
          card.innerHTML = `<img src="${image}" alt="${type}"><p>${type}</p>`;
          grid.appendChild(card);
        }

        for (const [type, total] of countMap) {
          const working = workingMap.get(type) || 0;
          const available = availableMap.get(type) || 0;
          if (type !== "" && total > 0 && (working / total) < 0.1) {
            addNotification("Quantity Alert: " + type + " has less than 10% working components");
          }
          if (type !== "" && available == 0) {
            addNotification("Quantity Alert: " + type + " has no available items to be borrowed");
          }
        }

        loading.style.display = "none";
        grid.style.display = "grid";
      } catch (error) {
        loading.textContent = "Error loading components.";
        console.error("Error loading data:", error);
      }
    }

    loadComponents();

    window.onclick = function(e) {
      const modal = document.getElementById('modal');
      if (e.target === modal) closeModal();
    };
  </script>
</body>
</html>
