<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="TeacherDashboard.css" />
</head>
<body>
  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>

    <div class="right">
      <div class="admin-nav">
        <div class="bubble-heading">Navigation</div>
        <a href="ManageClass.html"><button type="button">Manage Classroom</button></a>
      </div>

      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>
      </div>
    </div>
  </div>

  <!-- Modal to show component details -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-left">
        <div class="actions">
          <button id="addSingleComponentBtn" class="add-btn">Add Single Component</button>
          <button id="removeComponentBtn" class="remove-btn">Remove Component</button>
        </div>
  
        <div id="inlineAddForm" class="inline-add-form" style="display: none;">
          <h4>Add Single Component</h4>
          <input type="text" id="inlineAddTeam" placeholder="Team (e.g., 0 for storage)" />
          <label style="display: block; margin-top: 5px;">
            <input type="checkbox" id="inlineAddWorking" checked /> Working
          </label>
          <button id="inlineAddSubmitBtn" class="add-btn" style="margin-top: 8px;">Add Component</button>
        </div>
  
        <h3>Individual Parts</h3>
        <div id="partsList" class="parts-list scrollable-parts"></div>
      </div>
  
      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <!-- Modal to add a new component type -->
  <div class="modal" id="addTypeModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAddTypeModal()">&times;</span>
      <div class="modal-left">
        <h2>Add New Component Type</h2>
        <form id="addForm" class="add-form">
          <input type="text" id="newType" placeholder="Component type" required />
          <input type="text" id="newImage" placeholder="Image URL (optional)" />
          <label><input type="checkbox" id="newWorking" checked /> Working</label>
          <input type="text" id="newGroup" placeholder="Group (Set to 0 if in storage)" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      setDoc,
      getDocs,
      addDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const username = localStorage.getItem("username") || "Student";
    if (role !== "Teacher") {
    alert("Access denied: Teacher role required.");
    window.location.href = 'index.html';
  }
    document.getElementById("usernameHeader").textContent = `Welcome, ${username}`;
    document.title = `${username}'s Dashboard`;

    const workingMap = new Map();
    const availableMap = new Map();
    const countMap = new Map();
    const imageMap = new Map();
    let currentComponentType = null;

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    function closeAddTypeModal() {
      document.getElementById("addTypeModal").style.display = "none";
    }

    function addNotification(message) {
      const bar = document.getElementById("notification-bar");
      const note = document.createElement("div");
      note.className = "notif";
      note.textContent = message;
      bar.appendChild(note);
    }

    document.getElementById("addForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const type = document.getElementById("newType").value.trim();
      const image = document.getElementById("newImage").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
      const working = document.getElementById("newWorking").checked;
      const team = document.getElementById("newGroup").value.trim();

      if (!type || !team) return alert("Type and group are required.");

      try {
        await setDoc(doc(db, "inventory", type), { image }, { merge: true });
        const partsRef = collection(db, "inventory", type, "parts");
        await addDoc(partsRef, { working, team });

        alert("Component type added.");
        closeAddTypeModal();
        document.getElementById("addForm").reset();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear();
        workingMap.clear();
        availableMap.clear();
        loadComponents();
      } catch (err) {
        console.error("Add error:", err);
        alert("Failed to add component.");
      }
    });
document.getElementById("inlineAddSubmitBtn").addEventListener("click", async () => {
  const team = document.getElementById("inlineAddTeam").value.trim();
  const working = document.getElementById("inlineAddWorking").checked;

  if (!currentComponentType) {
    alert("No component selected.");
    return;
  }

  if (!team) {
    alert("Team is required.");
    return;
  }

  try {
    const partsRef = collection(db, "inventory", currentComponentType, "parts");
    await addDoc(partsRef, {
      working,
      team
    });

    alert("Component added successfully.");
    closeModal();

    // Refresh UI
    document.getElementById("component-grid").innerHTML = "";
    countMap.clear();
    workingMap.clear();
    availableMap.clear();
    await loadComponents();
  } catch (error) {
    console.error("Error adding component:", error);
    alert("Failed to add component.");
  }
});


    async function openModal(name, imageUrl) {
      currentComponentType = name;
      const total = countMap.get(name) || 0;
      const working = workingMap.get(name) || 0;
      const available = availableMap.get(name) || 0;

      document.getElementById("modal").style.display = "flex";
      document.getElementById("modalTitle").textContent = name;
      document.getElementById("modalImage").src = imageUrl;
      document.getElementById("totalCount").textContent = total;
      document.getElementById("AvailableCount").textContent = available;
      document.getElementById("WorkingCount").textContent = working;

      const greenPercent = total > 0 ? Math.round((working / total) * 100) : 0;
      const redPercent = 100 - greenPercent;
      const statusBar = document.querySelector('.status-bar');
      if (total === 0) {
        statusBar.innerHTML = `<div class="status yellow" style="width: 100%">100%</div>`;
      } else {
        statusBar.innerHTML = `
          <div class="status green" style="width: ${greenPercent}%">${greenPercent}%</div>
          <div class="status red" style="width: ${redPercent}%">${redPercent > 0 ? redPercent + '%' : ''}</div>
        `;
      }

      const partsContainer = document.getElementById("partsList");
      partsContainer.innerHTML = "Loading parts...";
      const partsRef = collection(db, "inventory", name, "parts");
      const partsSnapshot = await getDocs(partsRef);
      partsContainer.innerHTML = "";
      if (partsSnapshot.empty) {
        partsContainer.innerHTML = "<p>No parts found.</p>";
        return;
      }

      partsSnapshot.forEach(partDoc => {
        const data = partDoc.data();
        const div = document.createElement("div");
        div.className = "part-entry";
        div.innerHTML = `
          <p>Team: ${data.team} | Working: ${data.working ? '✅' : '❌'}</p>
          <button data-id="${partDoc.id}" class="remove-part-btn">Remove</button>
        `;
        partsContainer.appendChild(div);
      });

      partsContainer.querySelectorAll(".remove-part-btn").forEach(button => {
        button.addEventListener("click", async () => {
          const partId = button.getAttribute("data-id");
          const confirmDelete = confirm("Delete this part?");
          if (!confirmDelete) return;
          await deleteDoc(doc(db, "inventory", name, "parts", partId));
          alert("Deleted.");
          closeModal();
          loadComponents();
        });
      });
    }
    document.getElementById("addSingleComponentBtn").addEventListener("click", () => {
  const form = document.getElementById("inlineAddForm");
  form.style.display = form.style.display === "block" ? "none" : "block";
});

    document.getElementById("removeComponentBtn").addEventListener("click", async () => {
      if (!currentComponentType) return;
      const confirmDelete = confirm(`Delete ALL parts of ${currentComponentType}?`);
      if (!confirmDelete) return;

      const partsRef = collection(db, "inventory", currentComponentType, "parts");
      const partsSnapshot = await getDocs(partsRef);
      const deletePromises = partsSnapshot.docs.map(docSnap =>
        deleteDoc(doc(db, "inventory", currentComponentType, "parts", docSnap.id))
      );
      await Promise.all(deletePromises);
      await deleteDoc(doc(db, "inventory", currentComponentType));

      alert(`Deleted ${currentComponentType}`);
      closeModal();
      loadComponents();
    });

    async function loadComponents() {
      const grid = document.getElementById("component-grid");
      const loading = document.getElementById("loading");
      grid.innerHTML = "";

      try {
        const inventorySnapshot = await getDocs(collection(db, "inventory"));

        for (const typeDoc of inventorySnapshot.docs) {
          const type = typeDoc.id;
          const image = typeDoc.data().image || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
          imageMap.set(type, image);

          const partsRef = collection(db, "inventory", type, "parts");
          const partsSnapshot = await getDocs(partsRef);

          partsSnapshot.forEach(partDoc => {
            const { working, team } = partDoc.data();
            countMap.set(type, (countMap.get(type) || 0) + 1);
            if (working) {
              workingMap.set(type, (workingMap.get(type) || 0) + 1);
              if (team == "0") {
                availableMap.set(type, (availableMap.get(type) || 0) + 1);
              }
            }
          });
        }

        for (const [type, image] of imageMap) {
          const card = document.createElement("div");
          card.className = "card";
          card.onclick = () => openModal(type, image);
          card.innerHTML = `<img src="${image}" alt="${type}"><p>${type}</p>`;
          grid.appendChild(card);
        }

        // Add "+" card at the end
        const addCard = document.createElement("div");
        addCard.className = "card";
        addCard.style.justifyContent = "center";
        addCard.style.fontSize = "4rem";
        addCard.textContent = "+";
        addCard.onclick = () => {
          document.getElementById("addTypeModal").style.display = "flex";
        };
        grid.appendChild(addCard);

        loading.style.display = "none";
        grid.style.display = "grid";
      } catch (err) {
        console.error("Error loading components:", err);
        loading.textContent = "Error loading data.";
      }
    }

    loadComponents();

    window.onclick = function (e) {
      const modal = document.getElementById("modal");
      const addModal = document.getElementById("addTypeModal");
      if (e.target === modal) closeModal();
      if (e.target === addModal) closeAddTypeModal();
    };
  </script>
</body>
</html>
