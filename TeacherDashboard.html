<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="TeacherDashboard.css" />
</head>
<body>
  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>

    <div class="right">
      <div class="admin-nav">
        <div class="bubble-heading">Navigation</div>
        <a href="ManageClass.html"><button type="button">Manage Classroom</button></a>
      </div>

      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>
      </div>
    </div>
  </div>

  <!-- Component Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-left">
        <h2 id="modalTitle">Component</h2>
        <p>Total: <span id="totalCount"></span></p>
        <p>Available: <span id="availableCount">0</span></p>
        <p>Working: <span id="workingCount">0</span></p>
        <div class="actions">
          <button id="addSingleComponentBtn" class="add-btn">Add Single Component</button>
          <button id="removeComponentBtn" class="remove-btn">Remove Component</button>
        </div>

        <div id="inlineAddForm" class="inline-add-form" style="display: none;">
          <h4>Add Single Component (to Storage)</h4>
          <input type="text" id="inlineAddID" placeholder="Optional ID (alphanumeric, _ or -)">
          <label style="display: block; margin-top: 5px;">
            <input type="checkbox" id="inlineAddWorking" checked /> Working
          </label>
          <button id="inlineAddSubmitBtn" class="add-btn" style="margin-top: 8px;">Add Component</button>
        </div>

        <h3>Individual Parts</h3>
        <div id="partsList" class="parts-list scrollable-parts"></div>
      </div>

      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <!-- Add Type Modal -->
  <div class="modal" id="addTypeModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAddTypeModal()">&times;</span>
      <div class="modal-left">
        <h2>Add New Component Type</h2>
        <form id="addForm" class="add-form">
          <input type="text" id="newType" placeholder="Component type (ID)" required />
          <input type="text" id="newImage" placeholder="Image URL (optional)" />
          <input type="text" id="newGroup" placeholder="Group (0 = storage)" required />
          <label><input type="checkbox" id="newWorking" checked /> Working</label>
          <input type="text" id="newPartID" placeholder="Optional Part ID (alphanumeric, _ or -)">
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase & Dashboard Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDocs, getDoc, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentComponentType = null;
    const workingMap = new Map();
    const availableMap = new Map();
    const countMap = new Map();
    const imageMap = new Map();

    async function verifyUserRole() {
      const username = localStorage.getItem("username");
      if (!username) {
        alert("Missing login info.");
        window.location.href = "index.html";
        return;
      }

      try {
        const userRef = doc(db, "users", username);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          alert("User not found.");
          window.location.href = "index.html";
          return;
        }

        const role = (userSnap.data().role || "").toLowerCase();
        if (role !== "teacher") {
          alert("Access denied: Teacher role required.");
          window.location.href = "index.html";
          return;
        }

        document.getElementById("usernameHeader").textContent = `Welcome, ${username}`;
        document.title = `${username}'s Dashboard`;
        await loadComponents();
      } catch (err) {
        console.error("Role check error:", err);
        alert("Failed to validate user.");
        window.location.href = "index.html";
      }
    }
    verifyUserRole();

    async function loadComponents() {
      const loadingDiv = document.getElementById("loading");
      const grid = document.getElementById("component-grid");
      grid.innerHTML = "";

      try {
        const querySnapshot = await getDocs(collection(db, "inventory"));
        if (querySnapshot.empty) {
          loadingDiv.textContent = "No components found.";
          return;
        }

        loadingDiv.style.display = "none";
        grid.style.display = "grid";

        for (const docSnap of querySnapshot.docs) {
          const type = docSnap.id;
          const image = docSnap.data().image || "";
          imageMap.set(type, image);

          const partsSnap = await getDocs(collection(db, "inventory", type, "parts"));
          let total = 0, working = 0, available = 0;

          partsSnap.forEach(part => {
            const data = part.data();
            total++;
            if (data.working) working++;
            if (data.team === "0") available++;
          });

          countMap.set(type, total);
          workingMap.set(type, working);
          availableMap.set(type, available);

          const card = document.createElement("div");
          card.className = "component-card";
          card.innerHTML = `
            <img src="${image}" alt="${type}" class="component-thumb" />
            <h3>${type}</h3>
          `;
          card.addEventListener("click", () => openModal(type));
          grid.appendChild(card);
        }
      } catch (err) {
        console.error("Failed to load components:", err);
        loadingDiv.textContent = "Error loading components.";
      }
    }

    function openModal(type) {
      currentComponentType = type;
      const modal = document.getElementById("modal");
      document.getElementById("modalTitle").textContent = type;
      document.getElementById("modalImage").src = imageMap.get(type) || "";
      document.getElementById("totalCount").textContent = countMap.get(type);
      document.getElementById("availableCount").textContent = availableMap.get(type);
      document.getElementById("workingCount").textContent = workingMap.get(type);
      document.getElementById("partsList").innerHTML = "";

      getDocs(collection(db, "inventory", type, "parts")).then(snapshot => {
        snapshot.forEach(doc => {
          const partData = doc.data();
          const entry = document.createElement("div");
          entry.className = "part-entry";
          entry.innerHTML = `<strong>${doc.id}</strong> — Team: ${partData.team} — ${partData.working ? "✅ Working" : "❌ Broken"}`;
          document.getElementById("partsList").appendChild(entry);
        });
      });

      modal.style.display = "block";
    }

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    function closeAddTypeModal() {
      document.getElementById("addTypeModal").style.display = "none";
    }

    window.addEventListener("click", e => {
      if (e.target.id === "modal") closeModal();
      if (e.target.id === "addTypeModal") closeAddTypeModal();
    });

    window.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        closeModal();
        closeAddTypeModal();
      }
    });

    function addNotification(message) {
      const bar = document.getElementById("notification-bar");
      const note = document.createElement("div");
      note.className = "notif";
      note.textContent = message;
      bar.appendChild(note);
    }

    document.getElementById("addForm").addEventListener("submit", async function (e) {
      e.preventDefault();

      const type = document.getElementById("newType").value.trim();
      const image = document.getElementById("newImage").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
      const working = document.getElementById("newWorking").checked;
      const team = document.getElementById("newGroup").value.trim();
      const customPartID = document.getElementById("newPartID").value.trim();

      if (!type || !/^[a-zA-Z0-9_-]+$/.test(type)) return alert("Invalid component type.");
      if (!team) return alert("Group is required.");
      if (customPartID && !/^[a-zA-Z0-9_-]+$/.test(customPartID)) return alert("Invalid part ID.");

      try {
        await setDoc(doc(db, "inventory", type), { image }, { merge: true });
        const partsRef = collection(db, "inventory", type, "parts");

        if (customPartID) {
          const partRef = doc(partsRef, customPartID);
          if ((await getDoc(partRef)).exists()) return alert("Part already exists.");
          await setDoc(partRef, { working, team });
        } else {
          await addDoc(partsRef, { working, team });
        }

        alert("Component added.");
        closeAddTypeModal();
        document.getElementById("addForm").reset();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear(); workingMap.clear(); availableMap.clear();
        loadComponents();
      } catch (err) {
        console.error("Add error:", err);
        alert("Failed to add component.");
      }
    });

    document.getElementById("inlineAddSubmitBtn").addEventListener("click", async () => {
      const team = "0";
      const working = document.getElementById("inlineAddWorking").checked;
      const customID = document.getElementById("inlineAddID").value.trim();

      if (!currentComponentType) return alert("Select a component type first.");
      if (customID && !/^[a-zA-Z0-9_-]+$/.test(customID)) return alert("Invalid custom ID.");

      try {
        const partsRef = collection(db, "inventory", currentComponentType, "parts");
        if (customID) {
          const partRef = doc(partsRef, customID);
          if ((await getDoc(partRef)).exists()) return alert("Component already exists.");
          await setDoc(partRef, { working, team });
        } else {
          await addDoc(partsRef, { working, team });
        }

        alert("Component added.");
        closeModal();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear(); workingMap.clear(); availableMap.clear();
        await loadComponents();
      } catch (err) {
        console.error("Add error:", err);
        alert("Failed to add component.");
      }
    });

    document.getElementById("removeComponentBtn").addEventListener("click", async () => {
      if (!currentComponentType) return;
      if (!confirm("Delete this entire component type?")) return;

      try {
        await deleteDoc(doc(db, "inventory", currentComponentType));
        alert("Component deleted.");
        closeModal();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear(); workingMap.clear(); availableMap.clear();
        loadComponents();
      } catch (err) {
        console.error("Delete error:", err);
        alert("Failed to delete component.");
      }
    });

    // Add button to show inline add form
    document.getElementById("addSingleComponentBtn").addEventListener("click", () => {
      const form = document.getElementById("inlineAddForm");
      form.style.display = form.style.display === "none" ? "block" : "none";
    });
  </script>
</body>
</html>
