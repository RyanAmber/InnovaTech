<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="TeacherDashboard.css" />
</head>
<body>
  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>

    <div class="right">
      <div class="admin-nav">
        <div class="bubble-heading">Navigation</div>
        <a href="ManageClass.html"><button type="button">Manage Classroom</button></a>
      </div>

      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>
      </div>
    </div>
  </div>

  <!-- Component Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div class="modal-left">
        <h2 id="modalTitle">Component</h2>
        <p>Total: <span id="totalCount"></span></p>
        <p>Available: <span id="availableCount">0</span></p>
        <p>Working: <span id="workingCount">0</span></p>
        <div class="actions">
          <button id="addSingleComponentBtn" class="add-btn">Add Single Component</button>
          <!--<input type="text" id="inlineAddTeam" placeholder="Team (e.g., 0 for storage)" />Add commentMore actions
          <label style="display: block; margin-top: 5px;">
            <input type="checkbox" id="inlineAddWorking" checked /> Working
          </label>-->
          <button id="removeComponentBtn" class="remove-btn">Remove Component</button>
        </div>

        <div id="inlineAddForm" class="inline-add-form" style="display: none;">
          <h4>Add Single Component (to Storage)</h4>
          <label style="display: block; margin-top: 5px;">
            <input type="checkbox" id="inlineAddWorking" checked /> Working
          </label>
          <button id="inlineAddSubmitBtn" class="add-btn" style="margin-top: 8px;">Add Component</button>
        </div>


        <h3>Individual Parts</h3>
        <div id="partsList" class="parts-list scrollable-parts"></div>
      </div>

      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <!-- Add Type Modal -->
  <div class="modal" id="addTypeModal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeAddTypeModal()">&times;</span>
      <div class="modal-left">
        <h2>Add New Component Type</h2>
        <form id="addForm" class="add-form">
          <input type="text" id="newType" placeholder="Component type" required />
          <input type="text" id="newImage" placeholder="Image URL (optional)" />
          <label><input type="checkbox" id="newWorking" checked /> Working</label>
          <input type="text" id="newGroup" placeholder="Group (Set to 0 if in storage)" required />
          <button type="submit">Submit</button>
        </form>
      </div>
    </div>
  </div>

  <!-- FIREBASE + LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDocs, getDoc, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDq7FI-N984HO2M7Q0l25WEoiTBqZvZfHs",
      authDomain: "innovatech-86917.firebaseapp.com",
      projectId: "innovatech-86917",
      storageBucket: "innovatech-86917.appspot.com",
      messagingSenderId: "222788972248",
      appId: "1:222788972248:web:d0d5b8968f24b9c00671ad",
      measurementId: "G-GTX1QPXJ2R"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentComponentType = null;
    const workingMap = new Map();
    const availableMap = new Map();
    const countMap = new Map();
    const imageMap = new Map();

    async function verifyUserRole() {
      const username = localStorage.getItem("username");
      if (!username) {
        alert("Missing login info.");
        window.location.href = "index.html";
        return;
      }

      try {
        const userRef = doc(db, "users", username);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) {
          alert("User not found.");
          window.location.href = "index.html";
          return;
        }

        const role = (userSnap.data().role || "").toLowerCase();
        if (role !== "teacher") {
          alert("Access denied: Teacher role required.");
          window.location.href = "index.html";
          return;
        }

        document.getElementById("usernameHeader").textContent = `Welcome, ${username}`;
        document.title = `${username}'s Dashboard`;
      } catch (err) {
        console.error("Role check error:", err);
        alert("Failed to validate user.");
        window.location.href = "index.html";
      }
    }

    verifyUserRole();

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    function closeAddTypeModal() {
      document.getElementById("addTypeModal").style.display = "none";
    }

    function addNotification(message) {
      const bar = document.getElementById("notification-bar");
      const note = document.createElement("div");
      note.className = "notif";
      note.textContent = message;
      bar.appendChild(note);
    }

    document.getElementById("addForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const type = document.getElementById("newType").value.trim();
      const image = document.getElementById("newImage").value.trim() || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
      const working = document.getElementById("newWorking").checked;
      const team = document.getElementById("newGroup").value.trim();
      if (!type || !team) return alert("Type and group are required.");

      try {
        await setDoc(doc(db, "inventory", type), { image }, { merge: true });
        const partsRef = collection(db, "inventory", type, "parts");
        await addDoc(partsRef, { working, team });

        alert("Component type added.");
        closeAddTypeModal();
        document.getElementById("addForm").reset();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear(); workingMap.clear(); availableMap.clear();
        loadComponents();
      } catch (err) {
        console.error("Add error:", err);
        alert("Failed to add component.");
      }
    });

    document.getElementById("inlineAddSubmitBtn").addEventListener("click", async () => {
      const team = "0";  // always storage
      const working = document.getElementById("inlineAddWorking").checked;
      if (!currentComponentType) return alert("Select a component type first.");

      try {
        const partsRef = collection(db, "inventory", currentComponentType, "parts");
        await addDoc(partsRef, { working, team });
        alert("Component added.");
        closeModal();
        document.getElementById("component-grid").innerHTML = "";
        countMap.clear(); workingMap.clear(); availableMap.clear();
        await loadComponents();
      } catch (error) {
        console.error("Error adding component:", error);
        alert("Failed to add component.");
      }
    });

    async function openModal(name, imageUrl) {
      currentComponentType = name;
      document.getElementById("modal").style.display = "flex";
      document.getElementById("modalTitle").textContent = name;
      document.getElementById("modalImage").src = imageUrl;

      const total = countMap.get(name) || 0;
      const working = workingMap.get(name) || 0;
      const available = availableMap.get(name) || 0;

      document.getElementById("totalCount").textContent = total;
      document.getElementById("availableCount").textContent = available;
      document.getElementById("workingCount").textContent = working;

      const greenPercent = total > 0 ? Math.round((working / total) * 100) : 0;
      const redPercent = 100 - greenPercent;
      const statusBar = document.querySelector(".status-bar");
      statusBar.innerHTML = total === 0
        ? `<div class="status yellow" style="width: 100%">100%</div>`
        : `<div class="status green" style="width: ${greenPercent}%">${greenPercent}%</div>
           <div class="status red" style="width: ${redPercent}%">${redPercent ? redPercent + "%" : ""}</div>`;

      const partsContainer = document.getElementById("partsList");
      partsContainer.innerHTML = "Loading parts...";
      const partsRef = collection(db, "inventory", name, "parts");
      const partsSnapshot = await getDocs(partsRef);
      partsContainer.innerHTML = "";
      if (partsSnapshot.empty) {
        partsContainer.innerHTML = "<p>No parts found.</p>";
        return;
      }

      partsSnapshot.forEach(partDoc => {
        const data = partDoc.data();
        const div = document.createElement("div");
        div.className = "part-entry";
        div.innerHTML = `
          <p>Team: ${data.team}  Working: ${data.working ? '✅' : '❌'}</p>
          <button data-id="${partDoc.id}" class="remove-part-btn">Remove</button>
        `;
        partsContainer.appendChild(div);
      });

      partsContainer.querySelectorAll(".remove-part-btn").forEach(button => {
        button.addEventListener("click", async () => {
          const partId = button.getAttribute("data-id");
          if (!confirm("Delete this part?")) return;
          await deleteDoc(doc(db, "inventory", name, "parts", partId));
          alert("Deleted.");
          closeModal();
          loadComponents();
        });
      });
    }

    document.getElementById("addSingleComponentBtn").addEventListener("click", () => {
      const form = document.getElementById("inlineAddForm");
      form.style.display = form.style.display === "block" ? "none" : "block";
    });

    document.getElementById("removeComponentBtn").addEventListener("click", async () => {
      if (!currentComponentType) return;
      if (!confirm(`Delete ALL parts of ${currentComponentType}?`)) return;

      const partsRef = collection(db, "inventory", currentComponentType, "parts");
      const partsSnapshot = await getDocs(partsRef);
      await Promise.all(partsSnapshot.docs.map(docSnap =>
        deleteDoc(doc(db, "inventory", currentComponentType, "parts", docSnap.id))
      ));
      await deleteDoc(doc(db, "inventory", currentComponentType));

      alert(`Deleted ${currentComponentType}`);
      closeModal();
      loadComponents();
    });

    async function loadComponents() {
      const grid = document.getElementById("component-grid");
      const loading = document.getElementById("loading");
      grid.innerHTML = "";

      try {
        const inventorySnapshot = await getDocs(collection(db, "inventory"));

        for (const typeDoc of inventorySnapshot.docs) {
          const type = typeDoc.id;
          const image = typeDoc.data().image || "https://upload.wikimedia.org/wikipedia/commons/3/38/Arduino_Uno_-_R3.jpg";
          imageMap.set(type, image);

          const partsRef = collection(db, "inventory", type, "parts");
          const partsSnapshot = await getDocs(partsRef);
          partsSnapshot.forEach(partDoc => {
            const { working, team } = partDoc.data();
            countMap.set(type, (countMap.get(type) || 0) + 1);
            if (working) {
              workingMap.set(type, (workingMap.get(type) || 0) + 1);
              if (team === "0") {
                availableMap.set(type, (availableMap.get(type) || 0) + 1);
              }
            }
          });
        }

        for (const [type, image] of imageMap) {
          const card = document.createElement("div");
          card.className = "card";
          card.onclick = () => openModal(type, image);
          card.innerHTML = `<img src="${image}" alt="${type}"><p>${type}</p>`;
          grid.appendChild(card);
        }

        const addCard = document.createElement("div");
        addCard.className = "card";
        addCard.style.justifyContent = "center";
        addCard.style.fontSize = "4rem";
        addCard.textContent = "+";
        addCard.onclick = () => {
          document.getElementById("addTypeModal").style.display = "flex";
        };
        grid.appendChild(addCard);

        loading.style.display = "none";
        grid.style.display = "grid";
      } catch (err) {
        console.error("Error loading components:", err);
        loading.textContent = "Error loading data.";
      }
    }

    loadComponents();

    window.onclick = function (e) {
      if (e.target.classList.contains("modal")) {
        closeModal();
        closeAddTypeModal();
      }
    };
  </script>
</body>
</html>
