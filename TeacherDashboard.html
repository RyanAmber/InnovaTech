<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teacher Dashboard</title>
  <link rel="stylesheet" href="TeacherDashboard.css">
</head>
<body>
  <div style="position: absolute; top: 20px; right: 20px;">
    <button id="logout-Btn" class="logout-button">Logout</button>
  </div>

  <header id="usernameHeader">Welcome, </header>

  <div class="container">
    <div class="left">
      <div class="bubble-heading">Component List</div>
      <div id="loading" style="padding: 10px;">Loading components...</div>
      <div class="grid" id="component-grid" style="display: none;"></div>
    </div>
    <div class="middle">
      <div class="bubble-heading">Pending Items</div>
      <ul id="pending-list" class="pending-list"></ul>
    </div>
    <div class="right">
      <div class="admin-nav">
        <div class="bubble-heading">Navigation</div>
        <a href="ManageClass.html"><button type="button">Manage Classroom</button></a>
      </div>
      <div class="notifications-wrapper">
        <div class="bubble-heading">Notifications</div>
        <div class="notifications" id="notification-bar"></div>
      </div>
    </div>
  </div>

  <!-- Component Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <div class="modal-left">
        <h2 id="modalTitle">Component</h2>
        <p>Total: <span id="totalCount"></span></p>
        <p>Available: <span id="availableCount">0</span></p>
        <p>Working: <span id="workingCount">0</span></p>
        <div class="actions">
          <button id="addSingleComponentBtn" class="add-btn">Add Single Component</button>
          <button id="removeComponentBtn" class="remove-btn">Remove Component</button>
        </div>

        <div id="inlineAddForm" class="inline-add-form" style="display: none;">
          <h4>Add Single Component (to Storage)</h4>
          <input type="text" id="inlineAddID" placeholder="Optional ID">
          <label><input type="checkbox" id="inlineAddWorking" checked /> Working</label>
          <button id="inlineAddSubmitBtn" class="add-btn">Add Component</button>
        </div>

        <h3>Individual Parts</h3>
        <div id="partsList" class="parts-list scrollable-parts"></div>
      </div>

      <div class="modal-right">
        <img id="modalImage" class="component-img" src="" alt="Component Image">
        <div class="status-bar"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = { /* your config here */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentComponentType = null;
    const countMap = new Map();
    const workingMap = new Map();
    const availableMap = new Map();
    const imageMap = new Map();
    const partsMap = new Map();

    function closeModal() {
      document.getElementById("modal").style.display = "none";
    }

    async function loadComponents() {
      const loading = document.getElementById("loading");
      const grid = document.getElementById("component-grid");
      const pendingList = document.getElementById("pending-list");
      grid.innerHTML = "";
      pendingList.innerHTML = "";

      const snapshot = await getDocs(collection(db, "inventory"));
      for (const docSnap of snapshot.docs) {
        const type = docSnap.id;
        const image = docSnap.data().image || "";

        const partsSnapshot = await getDocs(collection(db, "inventory", type, "parts"));
        const parts = [];
        let total = 0, working = 0, available = 0;

        partsSnapshot.forEach(partDoc => {
          const data = partDoc.data();
          const part = { ...data, partID: data.partID || partDoc.id, group: data.group || "0" };
          parts.push(part);
          total++;
          if (part.working) working++;
          if ((part.group === "0" || part.group === 0) && part.working) available++;
          if (part.pending) {
            const li = document.createElement("li");
            li.textContent = `Type: ${type}, ID: ${part.partID}`;
            pendingList.appendChild(li);
          }
        });

        countMap.set(type, total);
        workingMap.set(type, working);
        availableMap.set(type, available);
        imageMap.set(type, image);
        partsMap.set(type, parts);

        const card = document.createElement("div");
        card.className = "component-card";
        card.innerHTML = `<img src="${image}" alt="${type}"><h3>${type}</h3>`;
        card.onclick = () => openModal(type);
        grid.appendChild(card);
      }

      loading.style.display = "none";
      grid.style.display = "grid";
    }

    function openModal(type) {
      currentComponentType = type;
      const modal = document.getElementById("modal");
      document.getElementById("modalTitle").textContent = type;
      document.getElementById("modalImage").src = imageMap.get(type) || "";
      document.getElementById("totalCount").textContent = countMap.get(type) || 0;
      document.getElementById("availableCount").textContent = availableMap.get(type) || 0;
      document.getElementById("workingCount").textContent = workingMap.get(type) || 0;

      const parts = partsMap.get(type) || [];
      const partsList = document.getElementById("partsList");
      partsList.innerHTML = "";

      for (const part of parts) {
        const entry = document.createElement("div");
        entry.className = "part-entry";
        entry.innerHTML = `
          <div>
            <strong>${part.partID}</strong><br>
            ${part.group && part.group !== "0" && part.group !== 0 ? `Possessed by: <strong>${part.group}</strong><br>` : 'In storage<br>'}
            ${part.pending ? '<em style="color: orange;">Pending Confirmation</em><br>' : ''}
            ${part.working ? 'Working' : 'Broken'}
          </div>
          <button class="delete-part-btn" data-part-id="${part.partID}">Delete</button>
        `;

        entry.querySelector(".delete-part-btn").addEventListener("click", async () => {
          if (!confirm(`Delete part "${part.partID}"?`)) return;
          await deleteDoc(doc(db, "inventory", currentComponentType, "parts", part.partID));
          alert(`Deleted part: ${part.partID}`);
          await loadComponents();
          openModal(currentComponentType);
        });

        partsList.appendChild(entry);
      }

      modal.style.display = "flex";
    }

    document.getElementById("logout-Btn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "index.html";
    });

    window.closeModal = closeModal;
    loadComponents();
  </script>
</body>
</html>
